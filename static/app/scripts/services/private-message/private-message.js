// Generated by CoffeeScript 1.8.0
(function() {
  var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  angular.module("worldsheet").factory("PrivateMessage", [
    "restmod", "Auth", "BS", "Alert", function(restmod, Auth, BS, Alert) {
      var PM;
      PM = restmod.model("/user/messages/").mix({
        $hooks: {
          'before-request': function(_req) {
            return _req.url += "/";
          }
        }
      });
      return {
        pm: PM.$build(),
        monitor: 0,
        deferred: {},
        compose: function(owner_id, post_id, items) {
          var self, user;
          self = this;
          self.monitor += 1;
          self.pm.recipient = owner_id;
          self.pm.post_id = post_id;
          self.pm.items = items;
          user = Auth.get_user();
          if (!user.is_anonymous) {
            self.pm.sender = user.id;
          } else {
            self.pm.sender = "ai.roswell@gmail.com";
          }
          return self.deferred = BS.bringUp("private-message");
        },
        send: function(subject, body) {
          var self;
          self = this;
          Alert.show_msg("Sending your message ...");
          this.pm.subject = subject;
          this.pm.body = body;
          this.pm.$save().$then(function(response) {
            Alert.show_msg("Messages is sent successfully!");
            return self.deferred.resolve();
          });
          self.deferred.promise;
          return location.reload();
        }
      };
    }
  ]).controller("privateMessageCtrl", [
    "$scope", "Item", "PrivateMessage", function($scope, Item, PrivateMessage) {
      var item_ids;
      $scope.PrivateMessage = PrivateMessage;
      $scope.items = [];
      item_ids = [];
      $scope.$watch("PrivateMessage.monitor", function() {
        var item_id, _i, _len, _ref, _results;
        if ($scope.post_id == null) {
          $scope.post_id = PrivateMessage.pm.post_id;
        } else if ($scope.post_id !== PrivateMessage.pm.post_id) {
          $scope.items = [];
          item_ids = [];
        }
        _ref = $scope.PrivateMessage.pm.items;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          item_id = _ref[_i];
          if (!(__indexOf.call(item_ids, item_id) >= 0)) {
            item_ids.push(item_id);
            _results.push(Item.$find(item_id).$then(function(response) {
              return $scope.items.push(response);
            }));
          } else {
            _results.push(void 0);
          }
        }
        return _results;
      });
      return $scope.send = function() {
        return PrivateMessage.send($scope.subject, $scope.body).then(function() {
          $scope.body = void 0;
          return $scope.subject = void 0;
        });
      };
    }
  ]);

}).call(this);
