{% extends "layout.html" %}
{% load url from future %}
{% load i18n %}{% load postman_tags %}
{% block content %}

<style type="text/css" scoped>
  .message-view-wrapper{
    padding: 0px 40px 40px 40px;
  }
  hr {
    border: 0;
    height: 1px;
    opacity: 0.5;
    background-image: -webkit-linear-gradient(left, rgba(0,0,0,0), rgba(0,0,0,0.75), rgba(0,0,0,0)); 
    background-image:    -moz-linear-gradient(left, rgba(0,0,0,0), rgba(0,0,0,0.75), rgba(0,0,0,0)); 
    background-image:     -ms-linear-gradient(left, rgba(0,0,0,0), rgba(0,0,0,0.75), rgba(0,0,0,0)); 
    background-image:      -o-linear-gradient(left, rgba(0,0,0,0), rgba(0,0,0,0.75), rgba(0,0,0,0)); 
  }
  img {
    max-width: 80%;max-height: 2048px;
  }
  .message-header{
    font-size: 18px;color: #999;
  }
  .message-sender{
    font-weight: 600;
  }
  .message-subject{
    font-size: 20px;font-weight: 600;
  }
  .message-body{
    background: #f4f4f4;padding: 20px;
    margin-top:10px;margin-bottom:20px;
  }
  [name='reply-form'] textarea{
    min-height: 300px;border-color: #eee;line-height: 1.2;
  }
  [name='reply-form'] textarea:focus{
    border-color: #ddd;
  }
</style>

<div class='message-view-wrapper' flex='80' ng-controller="messageViewCtrl">
  <div>
    <div class='section-title section-title-large'
        style='margin-bottom:0px;color:#4E85D5'>
      {% if pm_messages|length > 1 %}
      {% trans "Conversation" %}
      {% else %}
      {% trans "Message" %}
      {% endif %}
    </div>
    <div style='font-size:18px;color:#999'>
      Recent messages will appear <b>above</b> the older messages.
    </div>
  </div>
  <br/>
  <br/>
  {% load filters %}
  {% for message in pm_messages|order_by:"-sent_at" %}
  <div class="pm_message{% if message.is_pending %} pm_pending{% endif %}{% if message.is_rejected %} pm_rejected{% endif %}{% if message.sender == user and message.sender_archived or message.recipient == user and message.recipient_archived %} pm_archived{% endif %}{% if message.sender == user and message.sender_deleted_at or message.recipient == user and message.recipient_deleted_at %} pm_deleted{% endif %}{% if message.recipient == user and not message.read_at %} pm_unread{% endif %}">
    <div class='message-header' layout='row' layout-align='space-between center'>
      <div class="message-sender">
        From {{ message.obfuscated_sender|or_me:user }}
      </div>
      &nbsp;&nbsp;&nbsp;&nbsp;
      <div class="message-date">
        {{ message.sent_at|date:"DATETIME_FORMAT"}}
      </div>
    </div>
    <hr/>
    <br/>
    <div>
      <div class="message-subject">{{ message.subject }}</div>
      {% if message.is_rejected %}
      <div class="pm_status">
        {% trans "Rejected" %}
        {% if message.moderation_reason %}{% trans ":" %}
        {{ message.moderation_reason }}
        {% endif %}
      </div>
      {% endif %}
    </div>
    {% load markdown_deux_tags %}
    <div class="message-body">
      {{ message.body| markdown }}
    </div>
  </div>

  {% for item in message.request.all.0.items.all %}
    {% include 'search-item-overview.html' %}
    {% block item_overview %}
    {% endblock item_overview %}
  {% endfor%}

  <!-- Last loop: messages are all displayed -->
  {% if forloop.first %}
  <form name='message-form' action="" method="post" layout='row'>
    {% csrf_token %}
    <input type="hidden" {% if pm_messages|length > 1 and message.thread_id %}name="tpks" value="{{ message.thread_id }}"{% else %}name="pks" value="{{ message.pk }}"{% endif %} />
    <a href="{{ next_url }}">
      <div class='button button-small button-gray'>
        <i class="fa fa-arrow-left"></i>&nbsp;{% trans "Back" %}
      </div>
    </a>
    <div class='button button-small button-gray' type="submit"
        onclick="document.forms['message-form'].action='{% url 'postman_delete' %}?next={{ next_url|urlencode }}';
        document.forms['message-form'].submit();">
      <i class="fa fa-trash"></i> &nbsp;{% trans "Delete" %}
    </div>
    {% if not archived %}
    <div class='button button-small button-gray' type="submit"
        onclick="document.forms['message-form'].action='{% url 'postman_archive' %}?next={{ next_url|urlencode }}';
        document.forms['message-form'].submit();">
      <i class="fa fa-archive"></i>&nbsp;{% trans "Archive" %}
    </div>
    {% endif %}
    {% if reply_to_pk %}
    <a href="{% url 'postman_reply' reply_to_pk %}?next={{ next_url|urlencode }}">
      <div class='button button-small button-gray'>
        <i class="fa fa-reply"></i>&nbsp; {% trans "Reply" %}
      </div>
    </a>
    {% endif %}
  </form>
  {% if reply_to_pk %}
  <br/>
  <div class='text-large'>{% trans 'Quick Reply' %}</div>
  <br/>


  <form name='reply-form' action="{% url 'postman_reply' reply_to_pk %}?next={{ next_url|urlencode }}" method="post">
    {% csrf_token %}
    <div id="pm_reply">
      {{ form.body }}
    </div>
    <div class='button button-small button-gray'
        onclick="document.forms['reply-form'].submit()">
      {% trans 'Reply' %}
    </div>
  </form>
  {% endif %}
  {% endif %}
  {% endfor %}
</div>
{% endblock %}