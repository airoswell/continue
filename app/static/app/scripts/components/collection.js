// Generated by CoffeeScript 1.8.0
(function() {
  var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  angular.module("continue").filter("orderByField", [
    "Item", function(Item) {
      return function(collection, type, order_by) {
        if (type === 'field') {
          console.log("order_by = ", order_by);
          order_by = Item.customized_fields_normalization(order_by);
        }
        return collection;
      };
    }
  ]).controller("collectionCtrl", [
    "$scope", "Item", "Alert", "InfiniteScroll", "Auth", function($scope, Item, Alert, InfiniteScroll, Auth) {
      var infinite_scroll_items, search;
      $scope.items_search_results = [];
      $scope.layout = {
        creating_new_item: false,
        item_to_edit: {},
        filter_available: "",
        view_mode: "detail",
        items_search_results_order_by_type: "",
        items_search_results_order_by: "",
        show_items_search_results: false,
        search_result_not_found: false,
        loading: {
          "items": true
        }
      };
      $scope.tags = [];
      $scope.switch_view_mode = function(mode) {
        return $scope.layout.view_mode = mode;
      };
      $scope.filter_available = function(option) {
        if ($scope.layout.filter_available === option) {
          return $scope.layout.filter_available = "";
        } else {
          return $scope.layout.filter_available = option;
        }
      };
      $scope.edit_item = function(item) {
        if (item !== $scope.layout.item_to_edit) {
          return $scope.layout.item_to_edit = item;
        } else {
          return $scope.layout.item_to_edit = {};
        }
      };
      $scope.load_first_items = function() {
        if ($scope.items == null) {
          Alert.show_msg("Downloading your data ...");
          return $scope.items = Item.search({
            num_of_records: 8
          }).$then(function(response) {
            this.start = this.length;
            Alert.show_msg("Download is finished.");
            return $scope.layout.loading.items = false;
          }, function(e) {
            if (e.$response.status === 404) {
              return Alert.show_msg("No data is found.");
            } else {
              return Alert.show_error("There is problem retrieving your data.");
            }
          });
        }
      };
      $scope.load_first_items();
      infinite_scroll_items = new InfiniteScroll(Item);
      $scope.load_items = function() {
        infinite_scroll_items.config({
          model_types: ["Item"],
          init_starts: $scope.items.length
        });
        $scope.layout.loading.items = true;
        $scope.items = infinite_scroll_items.load($scope.items);
        return $scope.items.$asPromise().then(function(response) {
          infinite_scroll_items.success_handler(response);
          return $scope.layout.loading.items = false;
        }, function() {
          return Alert.show_msg("All items are downloaded ...");
        });
      };
      search = function(params) {
        $scope.layout.search_result_not_found = false;
        Alert.show_msg("Searching...");
        $scope.layout.show_items_search_results = true;
        return $scope.items_search_results = Item.search(params).$then(function() {
          return console.log("success");
        }, function(e) {
          if (e.$response.status = 404) {
            $scope.items_search_results = [];
            $scope.layout.search_result_not_found = true;
            return Alert.show_msg("There is no item matching the criteria.");
          }
        });
      };
      $scope.search_by_tag = function(tag) {
        var index, params, tags;
        if (__indexOf.call($scope.tags, tag) >= 0) {
          index = $scope.tags.indexOf(tag);
          $scope.tags.splice(index, 1);
        } else {
          $scope.tags.push(tag);
        }
        if ($scope.tags.length > 0) {
          tags = $scope.tags.join(",");
          params = {
            "tags": tags
          };
          search(params);
          return $scope.layout.show_items_search_results = true;
        } else {
          $scope.items_search_results = [];
          return $scope.layout.show_items_search_results = false;
        }
      };
      $scope.search_by_field = function(field) {
        var model_name, params;
        if ($scope.layout.items_search_results_order_by === field) {
          $scope.layout.items_search_results_order_by = "";
          $scope.layout.items_search_results_order_by_type = "";
          $scope.layout.show_items_search_results = false;
          return;
        }
        params = {
          order_by: field.title,
          order_by_model: field.model_name
        };
        model_name = Item.customized_fields_normalization(field).model_name;
        return search(params).$asPromise().then(function(response) {
          var f, item, _i, _len;
          for (_i = 0, _len = response.length; _i < _len; _i++) {
            item = response[_i];
            f = _.find(item[model_name], {
              "title": field.title
            });
            item['order_by_value'] = f.value;
          }
          $scope.layout.items_search_results_order_by = field;
          $scope.layout.items_search_results_order_by_type = 'field';
          return $scope.layout.show_items_search_results = true;
        });
      };
      $scope.is_searched = function(tag) {
        return __indexOf.call($scope.tags, tag) >= 0;
      };
      $scope.creating_new_item = function() {
        var item, items, _i, _len;
        if (!($scope.items != null)) {
          return false;
        }
        items = $scope.items;
        if (items.length > 0) {
          for (_i = 0, _len = items.length; _i < _len; _i++) {
            item = items[_i];
            if (!('id' in item)) {
              return true;
            }
          }
        }
        return false;
      };
      return $scope.create_item = function() {
        var item;
        if ($scope.creating_new_item()) {
          return;
        }
        if ($scope.items == null) {
          $scope.items = [];
        }
        $scope.layout.view_mode = "detail";
        $scope.layout.show_items_search_results = false;
        item = Item.$build(Item.init);
        item.owner = Auth.get_profile().id;
        item.is_new = true;
        $scope.items.splice(0, 0, item);
        $("html, body").animate({
          scrollTop: $("#items-display").offset().top - 100
        });
        return true;
      };
    }
  ]).directive("thumbnailItem", function() {
    return {
      restrict: "A",
      scope: {
        item: "="
      }
    };
  });

}).call(this);
