// Generated by CoffeeScript 1.8.0
(function() {
  angular.module("worldsheet").controller("itemTimelineCtrl", [
    "$scope", "InfiniteScroll", "ItemTimeline", "Update", "Alert", function($scope, InfiniteScroll, ItemTimeline, Update, Alert) {
      var infinite_scroll_timeline;
      $scope.layout = {
        loading: {
          timeline: true
        },
        display_section: "timeline",
        display_record: void 0,
        display_records: []
      };
      $scope.field_records_dict = {};
      $scope.$watch("item_id", function() {
        return $scope.timeline = ItemTimeline.$search({
          item_id: $scope.item_id,
          num_of_records: 0
        }).$then(function(response) {
          $scope.layout.loading.timeline = false;
          console.log("$scope.init_starts", $scope.init_starts);
          return response.starts = $scope.init_starts;
        });
      });
      infinite_scroll_timeline = new InfiniteScroll(ItemTimeline);
      $scope.load_timeline = function() {
        $scope.layout.loading.timeline = true;
        console.log("$scope.timeline.starts", $scope.timeline.starts);
        infinite_scroll_timeline.config({
          init_starts: $scope.init_starts,
          model_types: ["ItemEditRecord", "ItemTransactionRecord"],
          extra_params: {
            num_of_records: 8
          }
        });
        $scope.timeline = infinite_scroll_timeline.load($scope.timeline);
        return $scope.timeline.$asPromise().then(function(response) {
          console.log("response", response);
          infinite_scroll_timeline.success_handler(response);
          return $scope.layout.loading.timeline = false;
        }, function() {
          return Alert.show_msg("All timeline events are downloaded ...");
        });
      };
      $scope.add_field = function(field_title) {
        var field_record;
        Alert.show_msg("Downloading your data ...");
        $scope.layout.display_section = "field-records";
        field_record = Update.$search({
          item_id: $scope.item_id,
          field: field_title
        });
        $scope.field_records_dict[field_title] = field_record;
        return field_record.$then(function(response) {
          console.log("response", response);
          return Alert.show_msg("Done.");
        }, function(e) {
          return console.log("error");
        });
      };
      $scope.clear = function() {
        $scope.layout.display_section = "timeline";
        return $scope.field_records_dict = {};
      };
      return $scope.is_displaying = function(field_title) {
        if (field_title in $scope.field_records_dict) {
          return true;
        }
        return false;
      };
    }
  ]);

}).call(this);
