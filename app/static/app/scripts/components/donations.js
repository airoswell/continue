// Generated by CoffeeScript 1.8.0
(function() {
  console.log("donations");

  angular.module("continue").controller("donationsCtrl", [
    "$scope", "Item", "BulkItems", "Alert", function($scope, Item, BulkItems, Alert) {
      $scope.layout = {
        display_tab: 0,
        success: false,
        submitted: false
      };
      $scope.bulk_items = BulkItems.$build();
      $scope.items = [];
      $scope.items_title = [];
      $scope.items_tag = [];
      $scope.customized_char_fields = [
        {
          title: "Donor's name",
          value: ""
        }, {
          title: "Donor's address",
          value: ""
        }, {
          title: "Donor's zip code",
          value: ""
        }, {
          title: "Donor's phone",
          value: ""
        }, {
          title: "Donor's email",
          value: ""
        }, {
          title: "Donor's pick-up info",
          value: ""
        }, {
          title: "Donor's preferred pick-up date",
          value: ""
        }
      ];
      $scope.$watch("collector_uid", function() {
        var item;
        item = Item.$build(Item.init);
        item.owner = $scope.collector_uid;
        item.type = "donation";
        item.customized_num_fields = [];
        item.customized_num_fields.push({
          title: "Age",
          unit: "year",
          value: 0
        });
        $scope.items.push(item);
        return $scope.items_title.push(item.title);
      });
      $scope.$watch("items", function(newVal) {
        return $('textarea').autosize();
      }, true);
      $scope.add_item = function() {
        var item;
        item = Item.$build(Item.init);
        item.owner = $scope.collector_uid;
        item.type = "donation";
        item.customized_num_fields = [];
        item.customized_num_fields.push({
          title: "Age",
          unit: "year",
          value: 0
        });
        return $scope.items.push(item);
      };
      $scope.is_valid = function() {
        var is_valid, pat;
        if (!$scope.contactForm.$valid) {
          Alert.show_msg("Please fill in your name and area");
          return false;
        }
        if (!$scope.customized_char_fields[2].value && !$scope.customized_char_fields[3].value) {
          Alert.show_msg("Please provide either your phone number or your email address.");
          return false;
        } else if (!$scope.customized_char_fields[3].value) {
          pat = /\d{3}[^0-9]*\d{3}[^0-9]*\d{4}$/;
          is_valid = pat.test($scope.customized_char_fields[2].value);
          if (!is_valid) {
            Alert.show_msg("Please provide valid phone number");
            return false;
          }
        }
        return true;
      };
      return $scope.submit = function() {
        var item, _i, _len, _ref;
        console.log("submitting");
        if (!$scope.is_valid()) {
          return;
        }
        _ref = $scope.items;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          item = _ref[_i];
          if (item.quantity === "5 +") {
            item.quantity = 6;
          }
          item.customized_char_fields = $scope.customized_char_fields;
        }
        $scope.bulk_items.items = $scope.items;
        $scope.layout.submitted = true;
        Alert.show_msg("Submitting your data ...");
        return $scope.bulk_items.$save().$then(function(response) {
          console.log(response);
          $scope.received_items = response.items;
          Alert.show_msg("Successfully submitted your data.");
          $scope.items = [];
          return $scope.layout.success = true;
        });
      };
    }
  ]);

}).call(this);
