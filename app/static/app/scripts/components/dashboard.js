// Generated by CoffeeScript 1.8.0
(function() {
  angular.module("continue").controller("DashBoardCtrl", [
    "$scope", "Post", "Item", "Feed", "Timeline", "Alert", "Auth", function($scope, Post, Item, Feed, Timeline, Alert, Auth) {
      Alert.show_msg("Downloading your data.");
      $scope.items = Item.$search({
        num_of_records: 8
      }).$then(function() {
        var item, tag, _i, _len, _ref;
        _ref = $scope.items;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          item = _ref[_i];
          if (item.tags) {
            item.tags_input = [
              (function() {
                var _j, _len1, _ref1, _results;
                _ref1 = item.tags.split(",");
                _results = [];
                for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
                  tag = _ref1[_j];
                  _results.push({
                    "text": tag
                  });
                }
                return _results;
              })()
            ][0];
            item.tags = item.tags.split(",");
          }
        }
        return Alert.show_msg("Download is finished.");
      });
      $scope.layout = {
        creating_new_item: false,
        display_tab: "items",
        loading: {
          "posts": false,
          "feeds": false,
          "timeline": false,
          "items": false
        }
      };
      $scope.load_posts = function() {
        $scope.layout.loading.posts = true;
        if (!$scope.posts) {
          $scope.posts = Post.search({
            "start": $scope.numOfPosts
          });
        } else {
          $scope.posts = $scope.posts.fetch({
            "start": $scope.posts.start
          });
        }
        return $scope.posts.$then(function(response) {
          var post, _i, _len, _ref, _results;
          if ($scope.posts.start === 0) {
            $scope.posts.start = parseInt($scope.numOfPosts) + $scope.posts.length;
          } else {
            $scope.posts.start = parseInt($scope.numOfPosts) + $scope.posts.length;
          }
          _ref = $scope.posts;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            post = _ref[_i];
            if (post.tags) {
              if (typeof post.tags === "string") {
                _results.push(post.tags = post.tags.split(","));
              } else {
                _results.push(void 0);
              }
            } else {
              _results.push(post.tags = []);
            }
          }
          return _results;
        }).$asPromise().then(function() {
          return $scope.layout.loading.posts = false;
        }, function() {
          return Alert.show_msg("You have reach the end of the posts.");
        });
      };
      $scope.load_items = function() {
        $scope.layout.loading.items = true;
        if (!$scope.items) {
          $scope.items = Item.search({
            "start": 0
          });
        } else {
          $scope.items = $scope.items.fetch({
            "start": $scope.items.start
          });
        }
        return $scope.items.$then(function(response) {
          var post, _i, _len, _ref, _results;
          if ($scope.items.start === 0) {
            $scope.items.start = parseInt($scope.numOfPosts) + $scope.items.length;
          } else {
            $scope.items.start = parseInt($scope.numOfPosts) + $scope.items.length;
          }
          _ref = $scope.items;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            post = _ref[_i];
            if (post.tags) {
              if (typeof post.tags === "string") {
                _results.push(post.tags = post.tags.split(","));
              } else {
                _results.push(void 0);
              }
            } else {
              _results.push(post.tags = []);
            }
          }
          return _results;
        }).$asPromise().then(function() {
          return $scope.layout.loading.items = false;
        }, function() {
          return Alert.show_msg("You have reach the end of the posts.");
        });
      };
      $scope.load_feeds = function() {
        $scope.layout.loading.feeds = true;
        if (!$scope.feeds) {
          $scope.feeds = Feed.$search({
            "starts": $scope.feed_starts
          });
        } else {
          $scope.feeds = $scope.feeds.$fetch({
            "starts": $scope.feeds.starts
          });
        }
        return $scope.feeds.$then(function(response) {
          var feed, item, post, _i, _len, _ref, _results;
          $scope.feeds.starts = $scope.feed_starts;
          _ref = $scope.feeds;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            feed = _ref[_i];
            if (feed.model_name === "Post") {
              $scope.feeds.starts.Post += 1;
              post = feed;
              if (post.tags) {
                if (typeof post.tags === "string") {
                  post.tags = post.tags.split(",");
                }
              } else {
                post.tags = [];
              }
            }
            if (feed.model_name === "Item") {
              $scope.feeds.starts.Item += 1;
              item = feed;
              if (item.tags) {
                if (typeof item.tags === "string") {
                  _results.push(item.tags = item.tags.split(","));
                } else {
                  _results.push(void 0);
                }
              } else {
                _results.push(item.tags = []);
              }
            } else if (feed.model_name === "ItemEditRecord") {
              _results.push($scope.feeds.starts.ItemEditRecord += 1);
            } else {
              _results.push(void 0);
            }
          }
          return _results;
        }).$asPromise().then(function() {
          return $scope.layout.loading.feeds = false;
        }, function() {
          return Alert.show_msg("All feeds are already loaded.");
        });
      };
      $scope.load_timeline = function() {
        $scope.layout.loading.timeline = true;
        if (!$scope.timeline) {
          $scope.timeline = Timeline.$search({
            "starts": $scope.timeline_starts
          });
        } else {
          $scope.timeline = $scope.timeline.$fetch({
            "starts": $scope.timeline.starts
          });
        }
        return $scope.timeline.$then(function(response) {
          var feed, model_name, _i, _len, _ref, _results;
          $scope.timeline.starts = {};
          for (model_name in $scope.timeline_starts) {
            $scope.timeline.starts[model_name] = $scope.timeline_starts[model_name];
          }
          _ref = $scope.timeline;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            feed = _ref[_i];
            if (feed.model_name === "ItemTransactionRecord") {
              _results.push($scope.timeline.starts.ItemTransactionRecord += 1);
            } else if (feed.model_name === 'ItemEditRecord') {
              _results.push($scope.timeline.starts.ItemEditRecord += 1);
            } else {
              _results.push(void 0);
            }
          }
          return _results;
        }).$asPromise().then(function() {
          return $scope.layout.loading.timeline = false;
        }, function() {
          return Alert.show_msg("All timeline records are downloaded.");
        });
      };
      $scope.display_tab = function(tab_name) {
        return $scope.layout.display_tab = tab_name;
      };
      $scope.scroll_to_post = function(id) {
        var top;
        top = $("#post-" + id).offset().top;
        $("html, body").animate({
          scrollTop: top - 100
        });
        return true;
      };
      $scope.create_item = function() {
        var item;
        if ($scope.layout.creating_new_item) {
          return;
        }
        $scope.layout.creating_new_item = true;
        $scope.layout.display_tab = "items";
        item = Item.$build(Item.init);
        item.is_new = true;
        $scope.items.splice(0, 0, item);
        $("html, body").animate({
          scrollTop: $("#items-display").offset().top - 100
        });
        return true;
      };
      $scope.create_post = function() {
        var post;
        if ($scope.layout.creating_new_post) {
          return;
        }
        layout.creating_new_post = true;
        post = Post.$build(Post.init);
        post.owner = Auth.get_user().user_id;
        $scope.posts.splice(0, 0, post);
        $("html, body").animate({
          scrollTop: $("#posts-display").offset().top - 100
        });
        return true;
      };
      $scope.post_create_successHandler = function(item, response) {
        layout.creating_new_post = false;
        return post.is_new = false;
      };
      $scope.post_update_successHandler = function(item, response) {
        return console.log("successfully updated the post.");
      };
      $scope.add_item = function(post) {
        return post.add_item();
      };
      return $scope.add_existing_item = function(post) {
        var item;
        item = post.add_item();
        return BottomSheet.show(item);
      };
    }
  ]);

}).call(this);
